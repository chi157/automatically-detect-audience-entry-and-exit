<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è§€çœ¾é€²å ´é¡¯ç¤º - OBS</title>
  <style>
      .follow-message { background: linear-gradient(90deg, #e3f0ff 0%, #d6eaff 50%, #eaf6ff 100%); border-radius: 24px; padding: 32px 60px 32px 32px; display: flex; flex-direction: row; align-items: center; box-shadow: 0 8px 32px rgba(0,0,0,0.18); animation: slideInX 0.7s cubic-bezier(0.23, 1, 0.32, 1); position: relative; overflow: hidden; max-width: 100vw; width: fit-content; border: 1.5px solid #7bb6f7; transition: width 0.2s cubic-bezier(0.23, 1, 0.32, 1); }
      .follow-text { color: #2176c7; font-size: 40px; font-weight: bold; margin-bottom: 10px; text-shadow: none; position: relative; z-index: 1; text-align: left; white-space: nowrap; }
      .follow-username { color: #2176c7; font-size: 54px; font-weight: bold; margin-bottom: 8px; text-shadow: none; position: relative; z-index: 1; text-align: left; white-space: nowrap; }
      .follow-sub-text { color: #2176c7; font-size: 26px; position: relative; z-index: 1; text-align: left; white-space: nowrap; }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Microsoft JhengHei', 'PingFang TC', 'Noto Sans TC', sans-serif; background: transparent; overflow: hidden; }
    .welcome-container { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); max-width: 98vw; width: auto; display: flex; justify-content: center; align-items: center; }
    .welcome-message { background: linear-gradient(90deg, #ffe3ef 0%, #ffd6ec 50%, #ffeaf6 100%); border-radius: 24px; padding: 32px 60px 32px 32px; display: flex; flex-direction: row; align-items: center; box-shadow: 0 8px 32px rgba(0,0,0,0.18); animation: slideInX 0.7s cubic-bezier(0.23, 1, 0.32, 1); position: relative; overflow: hidden; max-width: 100vw; width: fit-content; border: 1.5px solid #ffd6ec; transition: width 0.2s cubic-bezier(0.23, 1, 0.32, 1); }
    .welcome-text { color: #b84a6b; font-size: 40px; font-weight: bold; margin-bottom: 10px; text-shadow: none; position: relative; z-index: 1; text-align: left; white-space: nowrap; }
    .username { color: #b84a6b; font-size: 54px; font-weight: bold; margin-bottom: 8px; text-shadow: none; position: relative; z-index: 1; text-align: left; white-space: nowrap; }
    .sub-text { color: #b84a6b; font-size: 26px; position: relative; z-index: 1; text-align: left; white-space: nowrap; }
    .emoji { font-size: 48px; margin-bottom: 0; margin-right: 12px; animation: none; }
    @keyframes slideInX { from { transform: translateX(-80%) scale(0.95); opacity: 0; } to { transform: translateX(0) scale(1); opacity: 1; } }
    @keyframes slideOutX { from { transform: translateX(0) scale(1); opacity: 1; } to { transform: translateX(80%) scale(0.95); opacity: 0; } }
    .welcome-message.fade-out { animation: slideOutX 0.5s cubic-bezier(0.23, 1, 0.32, 1) forwards; }
  </style>
</head>
<body>
  <div class="follow-container" id="followContainer" style="display: none;">
    <div class="follow-message" id="followMessage">
      <img src="https://cdn-icons-png.flaticon.com/512/929/929564.png" alt="follow gif" style="width:120px;height:auto;margin-right:32px;border-radius:12px;box-shadow:0 4px 16px rgba(0,0,0,0.18);display:block;image-rendering:auto;" />
      <div style="display:flex;flex-direction:column;align-items:flex-start;justify-content:center;">
        <div style="display:flex;align-items:center;margin-bottom:8px;">
          <div class="emoji" style="font-size:48px;">ğŸ’™</div>
          <div class="follow-text">æ„Ÿè¬è¿½éš¨</div>
        </div>
        <div class="follow-username" id="followUsername"></div>
        <div class="follow-sub-text">ä½ æ˜¯æˆ‘çš„å‹•åŠ›ï¼</div>
      </div>
    </div>
  </div>

  <div class="welcome-container" id="welcomeContainer" style="display: none;">
    <div class="welcome-message" id="welcomeMessage">
      <img src="https://i.pinimg.com/originals/cf/22/bc/cf22bc296da06b2269d39b32905fce9b.gif" alt="welcome gif" style="width:120px;height:auto;margin-right:32px;border-radius:12px;box-shadow:0 4px 16px rgba(0,0,0,0.18);display:block;image-rendering:auto;" />
      <div style="display:flex;flex-direction:column;align-items:flex-start;justify-content:center;">
        <div style="display:flex;align-items:center;margin-bottom:8px;">
          <div class="emoji">ğŸ‰</div>
          <div class="welcome-text">æ­¡è¿</div>
        </div>
        <div class="username" id="username"></div>
        <div class="sub-text">åŠ å…¥ç›´æ’­é–“ï¼<br>è¿½éš¨æˆ‘æˆ‘æœƒå¾ˆæ„›ä½ â¤ï¸</div>
      </div>
    </div>
  </div>

  <script>
    let ws;
    let reconnectInterval = null;
    const messageQueue = [];
    let isShowingMessage = false;

    // é€£æ¥ Twitch Bot WebSocket
    let twitchWs;
    function connectTwitchWs() {
      if (twitchWs) {
        twitchWs.onopen = null;
        twitchWs.onclose = null;
        twitchWs.onerror = null;
        twitchWs.onmessage = null;
        if (twitchWs.readyState === WebSocket.OPEN || twitchWs.readyState === WebSocket.CONNECTING) {
          twitchWs.close();
        }
      }
      twitchWs = new WebSocket('ws://127.0.0.1:3301');
      twitchWs.onmessage = (event) => {
        try {
          const data = JSON.parse(event.data);
          if (data.type === 'twitch_user_join') {
            showWelcomeMessage(data.username);
            playWelcomeSound();
          }
          if (data.type === 'twitch_user_follow') {
            showFollowMessage(data.username);
            playWelcomeSound();
          }
        } catch (e) {}
      };
          function showFollowMessage(username) {
            const container = document.getElementById('followContainer');
            const message = document.getElementById('followMessage');
            const usernameElement = document.getElementById('followUsername');
            // è®“ GIF é‡æ–°æ’­æ”¾
            const gif = message.querySelector('img[alt="follow gif"]');
            if (gif) {
              const src = gif.src;
              gif.src = '';
              void gif.offsetWidth;
              gif.src = src;
            }
            usernameElement.textContent = username;
            container.style.display = 'block';
            message.classList.remove('fade-out');
            setTimeout(() => {
              message.classList.add('fade-out');
              setTimeout(() => {
                container.style.display = 'none';
              }, 500);
            }, 5000);
          }
      twitchWs.onclose = () => setTimeout(connectTwitchWs, 5000);
    }
    function playWelcomeSound() {
      const audio = new Audio('/drum.mp3');
      audio.volume = 0.5;
      audio.play();
    }
    connectTwitchWs();

    function showWelcomeMessage(username) {
      messageQueue.push(username);
      processQueue();
    }

    async function processQueue() {
      if (isShowingMessage || messageQueue.length === 0) {
        return;
      }
      isShowingMessage = true;
      const username = messageQueue.shift();
      const container = document.getElementById('welcomeContainer');
      const message = document.getElementById('welcomeMessage');
      const usernameElement = document.getElementById('username');
      // è®“ GIF é‡æ–°æ’­æ”¾
      const gif = message.querySelector('img[alt="welcome gif"]');
      if (gif) {
        const src = gif.src;
        gif.src = '';
        void gif.offsetWidth;
        gif.src = src;
      }
      usernameElement.textContent = username;
      container.style.display = 'block';
      message.classList.remove('fade-out');
      await new Promise(resolve => setTimeout(resolve, 5000));
      message.classList.add('fade-out');
      await new Promise(resolve => setTimeout(resolve, 500));
      container.style.display = 'none';
      isShowingMessage = false;
      processQueue();
    }

    // connect(); // å·²ç§»é™¤å¤šé¤˜çš„ connect å‘¼å«
  </script>
</body>
</html>