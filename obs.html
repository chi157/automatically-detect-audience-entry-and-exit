<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ËßÄÁúæÈÄ≤Â†¥È°ØÁ§∫ - OBS</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Microsoft JhengHei', 'PingFang TC', 'Noto Sans TC', sans-serif; background: transparent; overflow: hidden; }
    .welcome-container { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); min-width: 350px; max-width: 98vw; width: auto; display: flex; justify-content: center; align-items: center; }
    .welcome-message { background: linear-gradient(90deg, #ffe3ef 0%, #ffd6ec 50%, #ffeaf6 100%); border-radius: 24px; padding: 32px 60px 32px 32px; display: flex; flex-direction: row; align-items: center; box-shadow: 0 8px 32px rgba(0,0,0,0.18); animation: slideInX 0.7s cubic-bezier(0.23, 1, 0.32, 1); position: relative; overflow: hidden; min-width: 350px; max-width: 100vw; width: fit-content; border: 1.5px solid #ffd6ec; transition: width 0.2s cubic-bezier(0.23, 1, 0.32, 1); }
    .welcome-text { color: #b84a6b; font-size: 40px; font-weight: bold; margin-bottom: 10px; text-shadow: none; position: relative; z-index: 1; text-align: left; }
    .username { color: #b84a6b; font-size: 54px; font-weight: bold; margin-bottom: 8px; text-shadow: none; position: relative; z-index: 1; text-align: left; }
    .sub-text { color: #b84a6b; font-size: 26px; position: relative; z-index: 1; text-align: left; }
    .emoji { font-size: 48px; margin-bottom: 0; margin-right: 12px; animation: none; }
    @keyframes slideInX { from { transform: translateX(-80%) scale(0.95); opacity: 0; } to { transform: translateX(0) scale(1); opacity: 1; } }
    @keyframes slideOutX { from { transform: translateX(0) scale(1); opacity: 1; } to { transform: translateX(80%) scale(0.95); opacity: 0; } }
    .welcome-message.fade-out { animation: slideOutX 0.5s cubic-bezier(0.23, 1, 0.32, 1) forwards; }
    .stats { position: fixed; top: 20px; right: 20px; background: rgba(0, 0, 0, 0.7); color: white; padding: 15px 25px; border-radius: 15px; font-size: 20px; backdrop-filter: blur(10px); box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3); }
    .stats-number { color: #4ade80; font-weight: bold; font-size: 32px; }
  </style>
</head>
<body>
  <div class="stats">
    üë• Âú®Á∑ö‰∫∫Êï∏: <span class="stats-number" id="userCount">0</span>
  </div>

  <div class="welcome-container" id="welcomeContainer" style="display: none;">
    <div class="welcome-message" id="welcomeMessage">
      <img src="https://i.pinimg.com/originals/cf/22/bc/cf22bc296da06b2269d39b32905fce9b.gif" alt="welcome gif" style="width:120px;height:auto;margin-right:32px;border-radius:12px;box-shadow:0 4px 16px rgba(0,0,0,0.18);display:block;image-rendering:auto;" />
      <div style="display:flex;flex-direction:column;align-items:flex-start;justify-content:center;">
        <div style="display:flex;align-items:center;margin-bottom:8px;">
          <div class="emoji">üéâ</div>
          <div class="welcome-text">Ê≠°Ëøé</div>
        </div>
        <div class="username" id="username"></div>
        <div class="sub-text">Âä†ÂÖ•Áõ¥Êí≠ÈñìÔºÅ</div>
      </div>
    </div>
  </div>

  <script>
    let ws;
    let reconnectInterval = null;
    const messageQueue = [];
    let isShowingMessage = false;

    // ÈÄ£Êé• Twitch Bot WebSocket
    let twitchWs;
    function connectTwitchWs() {
      if (twitchWs) {
        twitchWs.onopen = null;
        twitchWs.onclose = null;
        twitchWs.onerror = null;
        twitchWs.onmessage = null;
        if (twitchWs.readyState === WebSocket.OPEN || twitchWs.readyState === WebSocket.CONNECTING) {
          twitchWs.close();
        }
      }
      twitchWs = new WebSocket('ws://localhost:3301');
      twitchWs.onmessage = (event) => {
        try {
          const data = JSON.parse(event.data);
          if (data.type === 'twitch_user_join') {
            showWelcomeMessage(data.username);
            playWelcomeSound();
          }
        } catch (e) {}
      };
      twitchWs.onclose = () => setTimeout(connectTwitchWs, 5000);
    }
    function playWelcomeSound() {
      const audio = new Audio('https://cdn.pixabay.com/audio/2022/07/26/audio_124bfae5b2.mp3');
      audio.volume = 0.5;
      audio.play();
    }
    connectTwitchWs();

    function connect() {
      console.log('Âª∫Á´ãÊñ∞ÁöÑ WebSocket ÈÄ£Á∑ö');
      if (ws) {
        ws.onopen = null;
        ws.onclose = null;
        ws.onerror = null;
        ws.onmessage = null;
        if (ws.readyState === WebSocket.OPEN || ws.readyState === WebSocket.CONNECTING) {
          ws.close();
        }
      }
      const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
      const wsUrl = `${protocol}//${window.location.host}`;
      ws = new WebSocket(wsUrl);

      ws.onopen = () => {
        console.log('Â∑≤ÈÄ£Êé•Âà∞‰º∫ÊúçÂô®');
        if (reconnectInterval) {
          clearInterval(reconnectInterval);
          reconnectInterval = null;
        }
        ws.send(JSON.stringify({ type: 'get_users' }));
      };

      ws.onmessage = (event) => {
        try {
          const data = JSON.parse(event.data);
          if (data.type === 'user_joined') {
            showWelcomeMessage(data.username);
            updateUserCount(data.currentUsers.length);
          } else if (data.type === 'user_left') {
            updateUserCount(data.currentUsers.length);
          } else if (data.type === 'users_list') {
            updateUserCount(data.users.length);
          }
        } catch (error) {
          console.error('ËôïÁêÜË®äÊÅØÈåØË™§:', error);
        }
      };

      ws.onclose = () => {
        console.log('ÈÄ£Á∑öÂ∑≤ÈóúÈñâÔºå5ÁßíÂæåÈáçÊñ∞ÈÄ£Êé•...');
        if (!reconnectInterval) {
          reconnectInterval = setInterval(connect, 5000);
        }
      };

      ws.onerror = (error) => {
        console.error('WebSocket ÈåØË™§:', error);
      };
    }

    function showWelcomeMessage(username) {
      messageQueue.push(username);
      processQueue();
    }

    async function processQueue() {
      if (isShowingMessage || messageQueue.length === 0) {
        return;
      }
      isShowingMessage = true;
      const username = messageQueue.shift();
      const container = document.getElementById('welcomeContainer');
      const message = document.getElementById('welcomeMessage');
      const usernameElement = document.getElementById('username');
      // ËÆì GIF ÈáçÊñ∞Êí≠Êîæ
      const gif = message.querySelector('img[alt="welcome gif"]');
      if (gif) {
        const src = gif.src;
        gif.src = '';
        void gif.offsetWidth;
        gif.src = src;
      }
      usernameElement.textContent = username;
      container.style.display = 'block';
      message.classList.remove('fade-out');
      await new Promise(resolve => setTimeout(resolve, 5000));
      message.classList.add('fade-out');
      await new Promise(resolve => setTimeout(resolve, 500));
      container.style.display = 'none';
      isShowingMessage = false;
      processQueue();
    }

    function updateUserCount(count) {
      document.getElementById('userCount').textContent = count;
    }

    connect();
  </script>
</body>
</html>